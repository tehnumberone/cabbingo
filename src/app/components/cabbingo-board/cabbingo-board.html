<div class="page-wrap">
    <div class="w-100">
        <div class="d-flex justify-content-center align-items-center w-100 banner">
            <a class="btn button login-btn" [routerLink]="['/edit-board']">
                Log in as captain
            </a>
        </div>
    </div>
    <div class="osrs-border-thick px-4 py-2">
        <div class="gap-2 d-flex justify-content-between">
            <div class="d-flex flex-column col-9">
                <div class="d-flex flex-row teams mb-2">
                    <button class="button btn" (click)="switchTeam(teamEnum.Team1)"
                        [ngClass]="currentTeam === teamEnum.Team1 ? 'btn selected-team' : ''">
                        {{teamNames[0]}}
                    </button>
                    <button class="button btn" (click)="switchTeam(teamEnum.Team2)"
                        [ngClass]="currentTeam === teamEnum.Team2 ? 'btn selected-team' : ''">
                        {{teamNames[1]}}
                    </button>
                </div>
                <div class="d-flex justify-content-center align-items-center h-100 w-100">
                    <div class="tiles column col-auto">
                        <div class="d-flex align-items-center gap-2">
                            <div class="d-flex align-items-center mx-2 me-0 row-tile">.</div>
                            @for(column of [].constructor(boardSize); track i; let i = $index){
                            @if(getTotalPoints() > 0 && calculateColumnBonuses(i) > 0){
                            <div class="d-flex justify-content-center gap-2 column-tile text-success">Column {{ i + 1 }}
                                <i class="bi bi-check-circle-fill"></i></div>
                            }
                            @else{
                            <div class="d-flex justify-content-center gap-2 column-tile">Column {{ i + 1 }}</div>
                            }
                            }
                        </div>
                        @for(row of bingoTiles; track rowIndex; let rowIndex = $index){
                        <div class="d-flex justify-content-left px-2 py-1 gap-2">
                            @if(getTotalPoints() > 0 && calculateRowBonuses(rowIndex) > 0){
                            <div class="d-flex flex-row gap-1 px-1 align-items-center row-tile text-success">Row {{ rowIndex + 1 }} <i
                                    class="bi bi-check-circle-fill"></i></div>
                            }
                            @else{
                            <div class="d-flex align-items-center row-tile">Row {{ rowIndex + 1 }}</div>
                            }
                            @for(tile of row; track tile.id){
                            <button class="btn tile px-1 py-2" (click)="onTileClick(tile)"
                                (mousemove)="onMouseMove($event)" (mouseenter)="onMouseEnter(tile.title)"
                                (mouseleave)="onMouseLeave()"
                                [ngClass]="{ 'tile-selected': tile === selectedTile, 'tile-completed': calculateTileProgress(tile) >= tile.conditions.amount}">
                                <div class="d-flex flex-column justify-content-center h-100 w-100">
                                    <img class="tile-image" [src]="tile.tileImg" />
                                </div>
                                <div class="progress"
                                    [ngClass]="{'progress-styling' : calculateTileProgress(tile) < tile.conditions.amount}"
                                    style="height: 5px;"
                                    [style.background-color]="calculateTileProgress(tile) >= tile.conditions.amount ? 'transparent!important' : null">
                                    <div class="progress-bar bg-success" role="progressbar"
                                        [style.background-color]="calculateTileProgress(tile) >= tile.conditions.amount ? 'transparent!important' : null"
                                        [style.width.%]="(calculateTileProgress(tile) / tile.conditions.amount) * 100"
                                        [attr.aria-valuenow]="calculateTileProgress(tile)" aria-valuemin="0"
                                        [attr.aria-valuemax]="tile.conditions.amount">
                                    </div>
                                </div>
                            </button>
                            }
                        </div>
                        }
                    </div>
                </div>
            </div>
            <div class="infoArea d-flex justify-content-between col-auto">
                <div>
                    <div class="infobox osrs-border d-flex flex-column justify-content-between align-items-center"
                        style="min-height: 300px">
                        @if(selectedTile){
                        <div>{{ selectedTile.description }}</div>
                        <div>
                            <img class="bossImage" [src]="selectedTile.bossSrc" />
                        </div>
                        <div class="d-flex flex-column align-items-center">
                            <div class="d-flex flex-row pt-3">
                                Points:
                                <p class="mx-2" style="color: rgb(8, 255, 8)">
                                    {{ selectedTile.points }}
                                </p>
                            </div>
                            <div class="accordion accordion-flush w-100" id="accordionFlushExample">
                                <div class="accordion-item">
                                    <h2 class="accordion-header">
                                        <button class="accordion-button button collapsed" type="button"
                                            data-bs-toggle="collapse" data-bs-target="#flush-collapseOne"
                                            aria-expanded="false" aria-controls="flush-collapseOne"
                                            [style.color]="calculateTileProgress(selectedTile) >= selectedTile.conditions.amount ? 'rgb(8, 255, 8)' :  'gray'">
                                            Progress: {{ calculateTileProgress(selectedTile) }} / {{
                                            selectedTile.conditions.amount }}
                                        </button>
                                    </h2>
                                    <div id="flush-collapseOne" class="accordion-collapse collapse"
                                        data-bs-parent="#accordionFlushExample">
                                        <div class="accordion-body px-2 py-1 m-0">@for(progress of
                                            selectedTile.conditions.progress;
                                            track p; let p = $index){
                                            <li class="d-flex flex-row dropdown-item p-0 m-0">
                                                <p class="p-0 m-0"
                                                    [style]="{'color': progress.obtained ? 'rgb(8, 255, 8)' : 'white'}">
                                                    {{
                                                    progress.name }}:</p>
                                                <p class="mx-2 p-0 m-0"
                                                    [style]="{'color': progress.obtained ? 'rgb(8, 255, 8)' : 'white'}">
                                                    {{ progress.obtained }}
                                                </p>
                                            </li>
                                            }
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        } @else{
                        <p>Click on a tile!</p>
                        }
                    </div>
                    <div
                        class="d-flex flex-column infobox osrs-border-brighter justify-content-center align-items-center">
                        <div class="d-flex d-row justify-content-center gap-2 py-1 m-0">
                            <button class="btn row-tile" style="width:115px; height:40px;"
                                [ngClass]="{'rules-btn-selected': bingoRulesOpened, 'rules-btn': !bingoRulesOpened}"
                                (click)="bingoRulesOpened = true;">
                                <p style="color:#FF9933; width:auto">Bingo Rulez</p>
                            </button>
                            <button class="btn row-tile" style="width:115px; height:40px;"
                                [ngClass]="{'rules-btn-selected': !bingoRulesOpened, 'rules-btn': bingoRulesOpened}"
                                (click)="bingoRulesOpened = false;">
                                <p style="color:#FF9933; width:auto">Tile Rulez</p>
                            </button>
                        </div>

                        <div class="rulesbox custom-scrollbar overflow-y-scroll osrs-border-darker">
                            @if(!bingoRulesOpened){
                            @if(!selectedTile?.rules || selectedTile?.rules?.length === 0){
                            There are no rules for this tile.
                            }@else{
                            @for(rule of selectedTile?.rules; track i; let i = $index){
                            @if(rule.includes('Excluded') || rule.includes('Allowed')){
                            {{ rule }}
                            } @else if(rule.includes('-')){
                            <strong style="color: #E40303;">{{ rule.replace('-', '') }}</strong>
                            } @else if(rule.includes('+')){
                            <strong style="color: #0CD90D;">{{ rule.replace('+', '') }}</strong>
                            } @else{
                            <strong style="color:#FF9933;">{{ rule }}</strong>
                            }
                            <br />}}}
                            @else {
                            <ul class="px-2">
                                <li>Multiple accounts are allowed, but only one can be logged in at once.</li>
                                <li>The EXP tile will only be counted for ONE account. If you are playing with
                                    multiple.
                                </li>
                                <li>Complete a full row or column to earn a {{ rowBonus }} point bonus!</li>
                                <li>Tiles can be completed in any order.</li>
                                <li style="color:#0CD90D;">Good luck and have fun!</li>
                            </ul>
                            }
                        </div>
                    </div>
                </div>
                <div class="mt-2">
                    <button class="btn button disabled float-bottom">
                        Total points: {{ getTotalPoints() }}
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
@if(teams[currentTeam]){
<div class="osrs-border-thick px-4 py-2 mb-4 d-flex flex-column justify-content-between">
    <app-cabbingo-stats [teams]="teams" [participants]="participants" [currentTeam]="currentTeam"
        [endDatetime]="info.end_date" [donations]="donations" [prizePool]="prizePool"></app-cabbingo-stats>
</div>}
<app-osrs-tooltip></app-osrs-tooltip>